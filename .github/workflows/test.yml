name: Test Rust Application

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libdbus-1-dev pkg-config

      - name: Create Downloads Directory
        run: |
          mkdir -p ~/Downloads
          echo "Created Downloads directory"

      - name: Create Test Rules
        run: |
          mkdir -p ~/.config/download-organizer
          cp download_rules.example.json ~/.config/download-organizer/download_rules.json
          echo "Copied example rules to config directory"

      - name: Build Application
        run: |
          cargo build --release --bin downloadManager
          echo "Application built successfully."

      - name: Create Test Files
        run: |
          # Create test files locally instead of downloading
          echo "test image content" > ~/Downloads/test_image.jpg
          echo "test pdf content" > ~/Downloads/sample.pdf
          echo "test archive" > ~/Downloads/archive.zip
          echo "test installer" > ~/Downloads/app.deb
          echo "test video" > ~/Downloads/video.mp4
          ls -la ~/Downloads/

      - name: Run Application (run-once mode)
        run: |
          ./target/release/downloadManager
          echo "Application completed."

      - name: Verify Files Organized
        run: |
          echo "Checking organized files..."
          ls -laR ~/Downloads/

          # Check that files were moved to correct locations
          if [ -f ~/Downloads/Organized/Images/test_image.jpg ]; then
            echo "✓ Image organized correctly"
          else
            echo "✗ Image not found in expected location" && exit 1
          fi

          if [ -f ~/Downloads/Organized/Documents/PDFs/sample.pdf ]; then
            echo "✓ PDF organized correctly"
          else
            echo "✗ PDF not found in expected location" && exit 1
          fi

          if [ -f ~/Downloads/Organized/Archives/archive.zip ]; then
            echo "✓ Archive organized correctly"
          else
            echo "✗ Archive not found in expected location" && exit 1
          fi

          if [ -f ~/Downloads/Organized/Installers/Linux/app.deb ]; then
            echo "✓ Linux installer organized correctly"
          else
            echo "✗ Linux installer not found in expected location" && exit 1
          fi

          if [ -f ~/Downloads/Organized/Video/video.mp4 ]; then
            echo "✓ Video organized correctly"
          else
            echo "✗ Video not found in expected location" && exit 1
          fi

          echo "All files organized successfully!"

      - name: Test Daemon Mode Startup
        run: |
          # Test that daemon mode starts correctly
          timeout 5 ./target/release/downloadManager --daemon || true
          echo "Daemon mode test completed"

      - name: Test Help Flag
        run: |
          ./target/release/downloadManager --help
          echo "Help flag works"
